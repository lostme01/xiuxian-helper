# -*- coding: utf-8 -*-
import sys
import pytz
import asyncio
from config import settings
from app.task_scheduler import scheduler
from app import redis_client 
from app.utils import mask_string, LOG_TYPE_MAP_ZH_TO_EN
from app.config_manager import update_setting
from app.context import get_application

# --- æŒ‡ä»¤å‡½æ•°å®šä¹‰ ---

async def _cmd_restart(client, event, parts):
    await event.reply("âœ… å¥½çš„ï¼Œæ­£åœ¨ä¸ºæ‚¨å®‰æ’é‡å¯æœåŠ¡...")
    await asyncio.sleep(1)
    sys.exit(0)

async def _cmd_task_list(client, event, parts):
    jobs = scheduler.get_jobs()
    if not jobs:
        await event.reply("å½“å‰æ²¡æœ‰æ­£åœ¨è®¡åˆ’ä¸­çš„ä»»åŠ¡ã€‚")
        return
    job_map = {'biguan_xiulian_task': 'é—­å…³ä¿®ç‚¼', 'heartbeat_check_task': 'è¢«åŠ¨å¿ƒè·³', 'active_status_heartbeat_task': 'ä¸»åŠ¨å¿ƒè·³', 'zongmen_dianmao_task': 'å®—é—¨ç‚¹å¯', 'taiyi_yindao_task': 'å¤ªä¸€é—¨Â·å¼•é“', 'huangfeng_garden_task': 'é»„æ«è°·Â·å°è¯å›­', 'inventory_refresh_task': 'åˆ·æ–°èƒŒåŒ…', 'learn_recipes_task': 'å­¦ä¹ å›¾çº¸ä¸¹æ–¹', 'chuang_ta_task_1': 'è‡ªåŠ¨é—¯å¡” (1)', 'chuang_ta_task_2': 'è‡ªåŠ¨é—¯å¡” (2)'}
    beijing_tz = pytz.timezone(settings.TZ)
    reply_text = "ğŸ—“ï¸ **å½“å‰è®¡åˆ’ä»»åŠ¡åˆ—è¡¨**:\n"
    for job in jobs:
        if job.id.startswith('delete_msg_'): continue
        job_name = job_map.get(job.id, job.id)
        if job.next_run_time:
            next_run = job.next_run_time.astimezone(beijing_tz).strftime('%Y-%m-%d %H:%M:%S')
            reply_text += f"\n- **{job_name}**\n  `ä¸‹æ¬¡è¿è¡Œ:` {next_run}"
    await event.reply(reply_text, parse_mode='md')

async def _cmd_redis_status(client, event, parts):
    status_text = "ğŸ—„ï¸ **Redis è¿æ¥çŠ¶æ€**\n"
    try:
        if redis_client.db and redis_client.db.ping():
            status_text += "  - `çŠ¶æ€`: âœ… è¿æ¥æˆåŠŸ\n"
            config = settings.REDIS_CONFIG
            password = config.get('password')
            masked_pass = mask_string(password) if password else "æœªè®¾ç½®"
            status_text += f"  - `ä¸»æœº`: `{config.get('host')}`\n"
            status_text += f"  - `ç«¯å£`: `{config.get('port')}`\n"
            status_text += f"  - `å¯†ç `: `{masked_pass}`\n"
            status_text += f"  - `DB`: `{config.get('db')}`"
        else:
            status_text += "  - `çŠ¶æ€`: âŒ è¿æ¥å¤±è´¥"
    except Exception as e:
        status_text += f"  - `çŠ¶æ€`: âŒ è¿æ¥å¼‚å¸¸: {e}"
    await event.reply(status_text, parse_mode='md')

async def _cmd_toggle_log(client, event, parts):
    if len(parts) < 2:
        status_text = "**å„æ¨¡å—æ—¥å¿—å¼€å…³çŠ¶æ€**:\n"
        en_to_zh_map = {v: k for k, v in LOG_TYPE_MAP_ZH_TO_EN.items()}
        for key_en, value in settings.LOGGING_SWITCHES.items():
            key_zh = en_to_zh_map.get(key_en, key_en)
            status_text += f"- **{key_zh}**: **{'å¼€å¯' if value else 'å…³é—­'}**\n"
        await event.reply(status_text, parse_mode='md')
        return
    if len(parts) != 3 or parts[2] not in ["å¼€", "å…³"]:
        await event.reply("ç”¨æ³•: `,æ—¥å¿—å¼€å…³ <ç±»å‹> <å¼€|å…³>`", parse_mode='md')
        return
    log_type, switch = parts[1], parts[2]
    log_type_en = LOG_TYPE_MAP_ZH_TO_EN.get(log_type)
    if not log_type_en:
        await event.reply(f"âŒ é”™è¯¯: æœªçŸ¥çš„æ—¥å¿—ç±»å‹ '{log_type}'ã€‚")
        return
    new_status = (switch == "å¼€")
    response_msg = update_setting(root_key='logging_switches', sub_key=log_type_en, value=new_status, success_message=f"**{log_type}** æ—¥å¿—å·² **{switch}**")
    await event.reply(response_msg, parse_mode='md')

async def _generic_task_trigger(client, event, parts, task_map):
    command_name = parts[0]
    task_key = task_map.get(command_name)
    app = get_application()
    if task_key and (task_func := app.client.task_plugins.get(task_key)):
        # --- æ ¸å¿ƒä¿®å¤ï¼šä¿å­˜è‡ªå·±å‘å‡ºçš„æ¶ˆæ¯ï¼Œå¹¶å¯¹å…¶è¿›è¡Œç¼–è¾‘ ---
        progress_message = await event.reply(f"â³ å¥½çš„ï¼Œæ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œ **[{command_name}]** ä»»åŠ¡...", parse_mode='md')
        try:
            await task_func(force_run=True)
            await progress_message.edit(f"âœ… **[{command_name}]** ä»»åŠ¡å·²æˆåŠŸæ‰§è¡Œå®Œæ¯•ã€‚")
        except Exception as e:
            await progress_message.edit(f"âŒ **[{command_name}]** ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: `{e}`")
    else:
        await event.reply(f"âŒ é”™è¯¯: æœªæ‰¾åˆ°ä¸ `{command_name}` å…³è”çš„ä»»åŠ¡ã€‚")

async def _cmd_trigger_common_task(client, event, parts):
    task_map = {"ç«‹å³é—­å…³": "biguan", "ç«‹å³ç‚¹å¯": "dianmao", "ç«‹å³é—¯å¡”": "chuang_ta", "ç«‹å³åˆ·æ–°èƒŒåŒ…": "update_inventory"}
    await _generic_task_trigger(client, event, parts, task_map)

async def _cmd_trigger_learning_task(client, event, parts):
    task_map = {"ç«‹å³å­¦ä¹ ": "learn_recipes"}
    await _generic_task_trigger(client, event, parts, task_map)

async def _cmd_trigger_sect_task(client, event, parts):
    task_map = {"ç«‹å³è¯å›­": "xiaoyaoyuan", "ç«‹å³å¼•é“": "yindao"}
    await _generic_task_trigger(client, event, parts, task_map)

async def _cmd_toggle_task(client, event, parts):
    if len(parts) < 2:
        await event.reply("ç”¨æ³•: `,ä»»åŠ¡å¼€å…³ <ä»»åŠ¡å> [<å¼€|å…³>]`", parse_mode='md')
        return
    task_name = parts[1]
    task_map = {
        'ç„éª¨': ('ç„éª¨æ ¡è€ƒ', 'exam_solver', 'enabled'), 'å¤©æœº': ('å¤©æœºè€ƒéªŒ', 'tianji_exam_solver', 'enabled'),
        'é—­å…³': ('é—­å…³ä¿®ç‚¼', 'task_switches', 'biguan'), 'ç‚¹å¯': ('å®—é—¨ç‚¹å¯', 'task_switches', 'dianmao'),
        'å­¦ä¹ ': ('è‡ªåŠ¨å­¦ä¹ ', 'task_switches', 'learn_recipes'), 'è¯å›­': ('è‡ªåŠ¨è¯å›­', 'task_switches', 'garden_check'),
        'èƒŒåŒ…': ('è‡ªåŠ¨åˆ·æ–°èƒŒåŒ…', 'task_switches', 'inventory_refresh'),
    }
    if task_name not in task_map:
        await event.reply(f"âŒ é”™è¯¯: æœªçŸ¥çš„ä»»åŠ¡å '{task_name}'ã€‚")
        return
    
    friendly_name, root_key, sub_key = task_map[task_name]
    
    if len(parts) == 2:
        if root_key == 'task_switches': current_value = settings.TASK_SWITCHES.get(sub_key)
        elif root_key == 'exam_solver': current_value = settings.EXAM_SOLVER_CONFIG.get(sub_key)
        else: current_value = settings.TIANJI_EXAM_CONFIG.get(sub_key)
        status_str = "å¼€å¯" if current_value else "å…³é—­"
        await event.reply(f"å½“å‰ **{friendly_name}** åŠŸèƒ½çŠ¶æ€: **{status_str}**", parse_mode='md')
        return
        
    if len(parts) == 3 and parts[2] in ["å¼€", "å…³"]:
        switch = parts[2]
        new_status = (switch == "å¼€")
        response_msg = update_setting(root_key=root_key, sub_key=sub_key, value=new_status, success_message=f"**{friendly_name}** åŠŸèƒ½å·² **{switch}**")
        await event.reply(response_msg, parse_mode='md')
    else:
        await event.reply("ç”¨æ³•: `,ä»»åŠ¡å¼€å…³ <ä»»åŠ¡å> <å¼€|å…³>`", parse_mode='md')

# --- æŒ‡ä»¤æ³¨å†Œä¸­å¿ƒ ---
def initialize_all_commands(client):
    """åœ¨æ­¤å‡½æ•°ä¸­æ³¨å†Œæ‰€æœ‰ç®¡ç†å‘˜æŒ‡ä»¤"""
    client.register_admin_command("é‡å¯", _cmd_restart, "ğŸ”„ é‡å¯åŠ©æ‰‹æœåŠ¡ã€‚", category="ç³»ç»Ÿç®¡ç†")
    client.register_admin_command("å¸®åŠ©", None, "â„¹ï¸ æ˜¾ç¤ºæ­¤å¸®åŠ©èœå•ã€‚", category="ç³»ç»Ÿç®¡ç†", aliases=["help"])
    client.register_admin_command("ä»»åŠ¡åˆ—è¡¨", _cmd_task_list, "ğŸ—“ï¸ æŸ¥è¯¢è®¡åˆ’ä¸­çš„ä»»åŠ¡ã€‚", category="ç³»ç»ŸæŸ¥è¯¢", aliases=["tasks"])
    client.register_admin_command("æŸ¥è¯¢redis", _cmd_redis_status, "ğŸ—„ï¸ æ£€æŸ¥Redisè¿æ¥çŠ¶æ€ã€‚", category="ç³»ç»ŸæŸ¥è¯¢")
    client.register_admin_command("æ—¥å¿—å¼€å…³", _cmd_toggle_log, "ğŸ“ æŸ¥çœ‹æˆ–è®¾ç½®æ—¥å¿—æ¨¡å—å¼€å…³ã€‚\nç”¨æ³•: `,æ—¥å¿—å¼€å…³ [<ç±»å‹>] [<å¼€|å…³>]`", category="ç³»ç»Ÿé…ç½®")
    client.register_admin_command("ä»»åŠ¡å¼€å…³", _cmd_toggle_task, "ğŸ”§ æŸ¥çœ‹æˆ–è®¾ç½®åå°ä»»åŠ¡å¼€å…³ã€‚\nç”¨æ³•: `,ä»»åŠ¡å¼€å…³ <ä»»åŠ¡å> [<å¼€|å…³>]`", category="ç³»ç»Ÿé…ç½®")
    client.register_admin_command("ç«‹å³é—­å…³", _cmd_trigger_common_task, "ç«‹å³æ‰§è¡Œä¸€æ¬¡é—­å…³ã€‚", category="æ¸¸æˆä»»åŠ¡")
    client.register_admin_command("ç«‹å³ç‚¹å¯", _cmd_trigger_common_task, "ç«‹å³æ‰§è¡Œä¸€æ¬¡å®—é—¨ç‚¹å¯ã€‚", category="æ¸¸æˆä»»åŠ¡")
    client.register_admin_command("ç«‹å³é—¯å¡”", _cmd_trigger_common_task, "ç«‹å³æ‰§è¡Œä¸€æ¬¡é—¯å¡”ã€‚", category="æ¸¸æˆä»»åŠ¡")
    client.register_admin_command("ç«‹å³åˆ·æ–°èƒŒåŒ…", _cmd_trigger_common_task, "ç«‹å³åˆ·æ–°èƒŒåŒ…ç¼“å­˜ã€‚", category="æ¸¸æˆä»»åŠ¡")
    client.register_admin_command("ç«‹å³å­¦ä¹ ", _cmd_trigger_learning_task, "ç«‹å³æ‰§è¡Œå­¦ä¹ å›¾çº¸ä»»åŠ¡ã€‚", category="æ¸¸æˆä»»åŠ¡")
    client.register_admin_command("ç«‹å³è¯å›­", _cmd_trigger_sect_task, "ç«‹å³æ£€æŸ¥è¯å›­ (é»„æ«è°·)ã€‚", category="æ¸¸æˆä»»åŠ¡")
    client.register_admin_command("ç«‹å³å¼•é“", _cmd_trigger_sect_task, "ç«‹å³æ‰§è¡Œå¼•é“ (å¤ªä¸€é—¨)ã€‚", category="æ¸¸æˆä»»åŠ¡")
